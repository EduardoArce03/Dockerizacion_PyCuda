<p-toast/>

<div class="surface-section px-4 py-6 border-round-lg mb-4 shadow-2">
    <div class="flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
            <h2 class="text-900 font-bold text-4xl m-0 mb-2">âš¡ PyCUDA Image Processor</h2>
            <p class="text-600 text-lg m-0">Acelera el procesamiento de imÃ¡genes con GPU</p>
        </div>
        <div>
            <p-chip
                *ngIf="cudaAvailable"
                label="CUDA Disponible"
                icon="pi pi-check-circle"
                styleClass="text-lg font-semibold"
                [style]="{'background-color': '#22c55e', 'color': 'white', 'padding': '0.75rem 1.5rem'}"
            ></p-chip>
            <p-chip
                *ngIf="!cudaAvailable"
                label="CUDA No Disponible"
                icon="pi pi-exclamation-triangle"
                styleClass="text-lg font-semibold"
                [style]="{'background-color': '#FF0033', 'color': 'white', 'padding': '0.75rem 1.5rem'}"
            ></p-chip>
        </div>
    </div>
</div>

<!-- Estado Inicial - Sin imagen seleccionada -->
<div *ngIf="!selectedFile">
    <div class="flex justify-content-center align-items-center" style="min-height: 400px;">
        <div class="card text-center w-full max-w-30rem">
            <div class="inline-flex align-items-center justify-content-center bg-primary border-circle mb-4" 
                 style="width: 100px; height: 100px;">
                <i class="pi pi-cloud-upload text-white" style="font-size: 3rem"></i>
            </div>
            
            <h3 class="text-900 font-bold text-2xl mb-2">Sube tu Imagen</h3>
            <p class="text-600 mb-4">JPG, PNG, WebP</p>
            
            <p-fileupload
                mode="basic"
                name="image"
                accept="image/*"
                [maxFileSize]="10000000"
                [auto]="false"
                chooseLabel="Seleccionar Imagen"
                chooseIcon="pi pi-upload"
                (onSelect)="onFileSelected($event)"
                [disabled]="isProcessing"
                styleClass="w-full"
            ></p-fileupload>
        </div>
    </div>
    
    <div class="card mt-4">
        <h5 class="text-900 mb-3">ðŸ“” Filtros Disponibles</h5>
        <div class="flex gap-3 overflow-x-auto pb-2">
            <div class="flex-shrink-0 p-3 surface-ground border-round-lg border-left-3 border-blue-500" style="min-width: 250px;">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-image text-blue-600 text-xl"></i>
                    <span class="text-900 font-bold">Emboss</span>
                    <p-tag severity="success" value="Activo" styleClass="ml-auto"></p-tag>
                </div>
                <p class="text-600 text-sm m-0">Crea efecto 3D tipo relieve</p>
            </div>
            
            <div class="flex-shrink-0 p-3 surface-ground border-round-lg border-left-3 border-purple-500" style="min-width: 250px;">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-box text-purple-600 text-xl"></i>
                    <span class="text-900 font-bold">Laplace</span>
                    <p-tag severity="success" value="Activo" styleClass="ml-auto"></p-tag>
                </div>
                <p class="text-600 text-sm m-0">Detecta bordes y contornos</p>
            </div>
            
            <div class="flex-shrink-0 p-3 surface-ground border-round-lg border-left-3 border-orange-500" style="min-width: 250px;">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-circle text-orange-600 text-xl"></i>
                    <span class="text-900 font-bold">Blur</span>
                    <p-tag severity="warning" value="PrÃ³ximo" styleClass="ml-auto"></p-tag>
                </div>
                <p class="text-600 text-sm m-0">Desenfoque gaussiano</p>
            </div>
        </div>
    </div>
</div>

<!-- Layout Principal - Con imagen seleccionada -->
<div *ngIf="selectedFile">
    
    <div class="card mb-3">
        <div class="flex align-items-center justify-content-between mb-3">
            <h5 class="m-0 text-primary">ðŸŽ´ Imagen Seleccionada</h5>
            <p-button
                icon="pi pi-times"
                label="Limpiar"
                styleClass="p-button-rounded p-button-danger p-button-outlined"
                (onClick)="reset()"
                [disabled]="isProcessing"
            ></p-button>
        </div>
        
        <div class="relative">
            <p-image
                [src]="previewUrl"
                alt="Original"
                width="100%"
                [preview]="true"
                imageClass="border-round-lg shadow-3"
                [imageStyle]="{'max-height': '500px', 'object-fit': 'contain', 'width': '100%'}"
            ></p-image>
            
            <div class="absolute bottom-0 left-0 right-0 bg-black-alpha-70 p-3 border-round-bottom-lg">
                <div class="flex align-items-center gap-2 text-white">
                    <i class="pi pi-file"></i>
                    <span class="font-semibold">
                        {{ selectedFile?.name }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-3">
        <h6 class="text-600 mb-3">ðŸ“” Filtros Disponibles</h6>
        <div class="flex gap-3 overflow-x-auto pb-2">
            <div class="flex-shrink-0 p-2 surface-ground border-round border-left-3 border-blue-500" style="min-width: 200px;">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-image text-blue-600"></i>
                    <span class="text-900 font-semibold text-sm">Emboss</span>
                    <p-tag severity="success" value="âœ“" styleClass="ml-auto" style="font-size: 0.7rem;"></p-tag>
                </div>
                <p class="text-600 text-sm m-0">Crea efecto 3D tipo relieve</p>
            </div>
            
            <div class="flex-shrink-0 p-2 surface-ground border-round border-left-3 border-purple-500" style="min-width: 200px;">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-box text-purple-600"></i>
                    <span class="text-900 font-semibold text-sm">Laplace</span>
                    <p-tag severity="success" value="âœ“" styleClass="ml-auto" style="font-size: 0.7rem;"></p-tag>
                </div>
                <p class="text-600 text-sm m-0">Detecta bordes y contornos</p>
            </div>
            
            <div class="flex-shrink-0 p-2 surface-ground border-round border-left-3 border-orange-500" style="min-width: 200px;">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-circle text-orange-600"></i>
                    <span class="text-900 font-semibold text-sm">Blur</span>
                    <p-tag severity="warning" value="..." styleClass="ml-auto" style="font-size: 0.7rem;"></p-tag>
                </div>
                <p class="text-600 text-sm m-0">Desenfoque gaussiano</p>
            </div>
        </div>
    </div>
    
    <div class="flex flex-column gap-3">
        <div class="grid">
            <div class="col-12 lg:col-6">
                <div class="card h-full">
                    <div class="flex align-items-center gap-2 mb-3">
                        <div class="flex align-items-center justify-content-center bg-primary border-circle" 
                            style="width: 40px; height: 40px;">
                            <i class="pi pi-filter text-white text-lg"></i>
                        </div>
                        <h6 class="m-0 text-900 font-bold">Tipo de Filtro</h6>
                    </div>
                    
                    <div class="flex gap-2 justify-content-center">
                        <div *ngFor="let filter of filterOptions" class="flex-1">
                            <div 
                                class="surface-border border-2 border-round-lg p-3 text-center cursor-pointer transition-all transition-duration-200 hover:border-primary hover:shadow-3"
                                [class.border-primary]="selectedFilter === filter.value"
                                [class.bg-primary-50]="selectedFilter === filter.value"
                                (click)="selectedFilter = filter.value"
                                style="min-height: 90px;">
                                <i class="pi text-3xl mb-2 block"
                                [ngClass]="{
                                    'pi-image text-primary': filter.value === 'emboss',
                                    'pi-box text-primary': filter.value === 'laplace',
                                    'pi-circle text-primary': filter.value === 'blur'
                                }"></i>
                                <div class="text-900 font-semibold text-sm">{{ filter.label }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kernel Size -->
            <div class="col-12 lg:col-6">
                <div class="card h-full">
                    <div class="flex align-items-center gap-2 mb-3">
                        <div class="flex align-items-center justify-content-center bg-blue-500 border-circle" 
                            style="width: 40px; height: 40px;">
                            <i class="pi pi-th-large text-white text-lg"></i>
                        </div>
                        <h6 class="m-0 text-900 font-bold">Kernel Size</h6>
                        <div class="ml-auto px-3 py-2 bg-primary-100 border-round text-primary font-bold">
                            {{ kernelSize }}Ã—{{ kernelSize }}
                        </div>
                    </div>
                    
                    <div class="px-2">
                        <p-slider
                            [(ngModel)]="kernelSize"
                            [min]="3"
                            [max]="101"
                            [step]="2"
                            (onChange)="validateKernelSize()"
                        ></p-slider>
                        
                        <div class="flex justify-content-between mt-3">
                            <small class="text-600 font-semibold">
                                <i class="pi pi-arrow-down mr-1"></i>Sutil (3)
                            </small>
                            <small class="text-600 font-semibold">
                                Intenso (101)<i class="pi pi-arrow-up ml-1"></i>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="col-12">
                <div class="card">
                    <div class="flex align-items-center gap-2 mb-3">
                        <div class="flex align-items-center justify-content-center bg-green-500 border-circle" 
                            style="width: 40px; height: 40px;">
                            <i class="pi pi-microchip-ai text-white text-lg"></i>
                        </div>
                        <h6 class="m-0 text-900 font-bold">Block Size GPU</h6>
                        <small class="text-500 ml-auto">
                            <i class="pi pi-info-circle mr-1"></i>16Ã—16 recomendado para imÃ¡genes HD
                        </small>
                    </div>
                    
                    <div class="flex gap-2">
                        <div *ngFor="let block of blockSizeOptions" class="flex-1">
                            <div 
                                class="surface-border border-2 border-round-lg p-3 text-center cursor-pointer transition-all transition-duration-200 hover:border-green-500 hover:shadow-2"
                                [class.border-green-500]="blockSize === block.value"
                                [class.bg-green-50]="blockSize === block.value"
                                [class.shadow-2]="blockSize === block.value"
                                (click)="blockSize = block.value">
                                <div class="text-900 font-bold text-xl mb-1">{{ block.label }}</div>
                                <small class="text-600 font-semibold">threads</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="col-12">
                <div class="card">
                    <div class="flex align-items-center gap-2 mb-3">
                        <div class="flex align-items-center justify-content-center bg-orange-500 border-circle" 
                            style="width: 40px; height: 40px;">
                            <i class="pi pi-bolt text-white text-lg"></i>
                        </div>
                        <h5 class="m-0 text-900 font-bold">Procesar Imagen</h5>
                    </div>
                    
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <p-button
                                label="Procesar con GPU"
                                icon="pi pi-bolt"
                                styleClass="w-full p-button-lg p-button-success"
                                [loading]="isProcessing"
                                [disabled]="isProcessing || !cudaAvailable"
                                (onClick)="processWithGPU()"
                            ></p-button>
                        </div>

                        <div class="col-12 md:col-6">
                            <p-button
                                label="Benchmark CPU vs GPU"
                                icon="pi pi-chart-bar"
                                styleClass="w-full p-button-lg p-button-warning"
                                [loading]="isProcessing"
                                [disabled]="isProcessing || !cudaAvailable"
                                (onClick)="comparePerformance()"
                            ></p-button>
                        </div>
                    </div>
                    
                    <div *ngIf="!cudaAvailable" class="mt-3 p-3 border-round-lg bg-orange-50 border-left-3 border-orange-500">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-exclamation-triangle text-orange-600 text-xl"></i>
                            <span class="text-orange-900 font-semibold">
                                GPU no disponible. Las funciones de aceleraciÃ³n estÃ¡n deshabilitadas.
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <div class="card mb-3" *ngIf="processedImageUrl">
        <div class="flex align-items-center justify-content-between gap-2 mb-3">
            <h5 class="m-0 text-green-600">âœ… Resultado</h5>
            <div class="flex gap-2">
                <p-tag 
                    *ngIf="processingTime"
                    icon="pi pi-clock" 
                    severity="success"
                    styleClass="font-bold"
                    [value]="processingTime?.toFixed(2) + 'ms'"
                ></p-tag>
                <p-button
                    icon="pi pi-download"
                    styleClass="p-button-rounded p-button-success"
                    (onClick)="downloadProcessedImage()"
                    pTooltip="Descargar"
                    label="Descargar"
                ></p-button>
            </div>
        </div>

        <p-image
                [src]="previewUrl"
                alt="Original"
                width="100%"
                [preview]="true"
                imageClass="border-round-lg shadow-3"
            ></p-image>
        
        <p-image
            [src]="processedImageUrl"
            alt="Processed"
            width="100%"
            [preview]="true"
            imageClass="border-round-lg shadow-3"
        ></p-image>
    </div>
    
    <!-- Benchmark Results -->
    <div class="card" *ngIf="comparisonResult">
        <h5 class="mb-4 text-orange-600">ðŸ“Š AnÃ¡lisis de Rendimiento</h5>
        
        <!-- Stats Grid 2x2 -->
        <div class="grid mb-3">
            <div class="col-12 md:col-6">
                <div class="text-center p-3 bg-blue-50 border-round-lg border-2 border-blue-200">
                    <i class="pi pi-desktop text-blue-600 text-2xl mb-2"></i>
                    <div class="text-blue-900 font-bold text-2xl">
                        {{ comparisonResult?.cpu?.processing_time_ms?.toFixed(0) }}
                    </div>
                    <div class="text-blue-700 text-xs font-semibold">ms CPU</div>
                </div>
            </div>
            
            <div class="col-12 md:col-6">
                <div class="text-center p-3 bg-green-50 border-round-lg border-2 border-green-200">
                    <i class="pi pi-bolt text-green-600 text-2xl mb-2"></i>
                    <div class="text-green-900 font-bold text-2xl">
                        {{ comparisonResult?.gpu?.processing_time_ms?.toFixed(0) }}
                    </div>
                    <div class="text-green-700 text-xs font-semibold">ms GPU</div>
                </div>
            </div>
        </div>
        
        <!-- Speedup Destacado -->
        <div class="relative mb-3 p-4 border-round-xl text-center shadow-3"
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="text-white opacity-90 text-sm font-semibold mb-1">AceleraciÃ³n GPU</div>
            <div class="text-white font-bold mb-1" style="font-size: 2.5rem;">
                {{ comparisonResult?.speedup }}Ã—
            </div>
            <div class="text-white opacity-90 text-sm font-semibold">
                {{ comparisonResult?.performance_gain }} mejor
            </div>
        </div>
        
        <!-- Detalles TÃ©cnicos -->
        <p-panel header="âš™ï¸ Detalles TÃ©cnicos" [toggleable]="true" [collapsed]="true">
            <div class="flex flex-column gap-2">
                <div class="flex justify-content-between align-items-center p-2 surface-ground border-round-lg">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-image text-600"></i>
                        <span class="text-600 text-sm font-semibold">ResoluciÃ³n</span>
                    </div>
                    <span class="text-900 font-bold text-sm">
                        {{ comparisonResult?.image_size?.width }}Ã—{{ comparisonResult?.image_size?.height }}
                    </span>
                </div>
                
                <div class="flex justify-content-between align-items-center p-2 surface-ground border-round-lg">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-th-large text-600"></i>
                        <span class="text-600 text-sm font-semibold">Kernel</span>
                    </div>
                    <span class="text-900 font-bold text-sm">
                        {{ comparisonResult?.kernel_size }}Ã—{{ comparisonResult?.kernel_size }}
                    </span>
                </div>
                
                <div class="flex justify-content-between align-items-center p-2 surface-ground border-round-lg">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-box text-600"></i>
                        <span class="text-600 text-sm font-semibold">Config GPU</span>
                    </div>
                    <span class="text-900 font-bold text-sm text-right">
                        {{ comparisonResult?.gpu?.block_config }}
                    </span>
                </div>
                
                <div class="flex justify-content-between align-items-center p-2 surface-ground border-round-lg">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-table text-600"></i>
                        <span class="text-600 text-sm font-semibold">Grid</span>
                    </div>
                    <span class="text-900 font-bold text-sm text-right">
                        {{ comparisonResult?.gpu?.grid_config }}
                    </span>
                </div>
            </div>
        </p-panel>
    </div>
</div>

<!-- Loading Overlay -->
<p-blockUI [blocked]="isProcessing">
    <div class="flex flex-column align-items-center gap-3 p-5 border-round-xl bg-white shadow-5">
        <div class="relative">
            <i class="pi pi-spin pi-cog text-primary" style="font-size: 3.5rem"></i>
            <i class="pi pi-bolt text-green-500 absolute" style="font-size: 2rem; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>
        </div>
        <div class="text-center">
            <div class="text-primary font-bold text-xl mb-1">Procesando con GPU...</div>
            <div class="text-600 text-sm">Esto puede tomar unos segundos</div>
        </div>
    </div>
</p-blockUI>